{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "APP ASG",

  "Parameters": {
    "EBSDeviceName": {
      "Description": "The name of the EBS device within Amazon EC2",
      "Type": "String"
    },
    "EBSVolumeSize": {
      "Description": "EBS Volumes size in gigabytes",
      "Type": "String"
    },
    "EBSVolumeType": {
      "Description": "EBS Volume type",
      "Type": "String"
    },
    "EBSDeleteOnTermination": {
      "Description": "Determines whether to delete the volume on instance termination",
      "Type": "String"
    },
    "EBSEncrypted": {
      "Description": "Determines if the EBS should be encypted",
      "Type": "String"
    },
    "ImageId": {
      "Description": "Provides the unique ID of the Amazon Machine Image (AMI)",
      "Type": "AWS::EC2::Image::Id"
    },
    "SlaveInstanceType": {
      "Description": "The type of the ec2 instance to create",
      "Type": "String"
    },
    "Timezone": {
      "Description": "Timezone",
      "Type": "String",
      "AllowedValues": [
        "New_York",
        "Chicago",
        "Denver",
        "Los_Angeles"
      ]
    },
    "SlaveName": {
      "Description": "Name of the ec2 Instance",
      "Type": "String",
      "Default": "App Slave node"
    },
    "ApplicationName": {
      "Description": "Name of application the instance is a part of",
      "Type": "String",
      "Default": "Voting Arena"
    },
    "OwnerContact": {
      "Type": "String"
    },
    "SlaveMinSize": {
      "Description": "Minimum number of slaves to having running at any given time",
      "Type": "String"
    },
    "SlaveMaxSize": {
      "Description": "Maximum number of slaves to having running at any given time",
      "Type": "String"
    },
    "SlaveSubnets": {
      "Description": "Subnets to launch slave nodes into",
      "Type": "CommaDelimitedList"
    },
    "LoadBalancerNames": {
      "Description": "ELB to connect the auto-scaling group to.",
      "Type": "CommaDelimitedList",
      "Default": ""
    },
    "IamInstanceProfile": {
      "Description": "Instance profile",
      "Type": "String"
    },
    "Uptime": {
      "Type": "String",
      "Description": "Uptime of the ec2 instance",
      "Default": "excluded"
    },
    "Environment": {
      "Description": "Environment to which this instance belongs.",
      "Type": "String",
      "Default": "Dev"
    }
  },

  "Resources": {
    "SlaveLaunchConfig": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "ImageId": {
          "Ref": "ImageId"
        },
        "InstanceType": {
          "Ref": "SlaveInstanceType"
        },
        "BlockDeviceMappings": [
          {
            "DeviceName": { "Ref": "EBSDeviceName" },
            "Ebs": {
              "VolumeSize": { "Ref": "EBSVolumeSize" },
              "VolumeType": { "Ref": "EBSVolumeType" },
              "Encrypted": { "Ref": "EBSEncrypted" },
              "DeleteOnTermination": { "Ref": "EBSDeleteOnTermination" }
            }
          }
        ],
        "SecurityGroups": { "Ref": "SlaveSecurityGroupIds" },
        "IamInstanceProfile": { "Ref": "IamInstanceProfile" },
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              [
                "#!/bin/bash -ex \n",
                "mkdir /etc/vault-aws-ec2-auth \n",
                "touch nonce \n",
                "uuidgen > /etc/vault-aws-ec2-auth/nonce \n",
                "chmod 777 /etc/vault-aws-ec2-auth/ \n"
              ]
            ]
          }
        }
      }
    },

    "SlaveASG": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "LaunchConfigurationName": { "Ref": "SlaveLaunchConfig" },
        "MinSize": { "Ref": "SlaveMinSize" },
        "MaxSize": { "Ref": "SlaveMaxSize" },
        "VPCZoneIdentifier": { "Ref": "SlaveSubnets" },
        "LoadBalancerNames": { "Ref": "LoadBalancerNames"},
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Ref": "SlaveName" },
            "PropagateAtLaunch": "true"
          },
          {
            "Key": "ApplicationName",
            "Value": { "Ref": "ApplicationName" },
            "PropagateAtLaunch": "true"
          },
          {
            "Key": "OwnerContact",
            "Value": { "Ref": "OwnerContact" },
            "PropagateAtLaunch": "true"
          },
          {
            "Key": "Uptime",
            "Value": { "Ref": "Uptime" },
            "PropagateAtLaunch": "true"
          },
          {
            "Key": "Environment",
            "Value": { "Ref": "Environment" },
            "PropagateAtLaunch": "true"
          }
        ]
      }
    }
  }
}
